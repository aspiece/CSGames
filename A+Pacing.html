<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CompTIA A+ Preparation</title>
  <style>
    :root {
      --bg: #0f1115;
      --card: #171a21;
      --text: #e6e8ee;
      --muted: #b9c0d4;
      --accent: #6ea8fe;
    }
    html, body { margin:0; padding:0; background:var(--bg); color:var(--text); font: 14px/1.45 system-ui, Segoe UI, Roboto, Arial, sans-serif; }
    .wrap { max-width: 1100px; margin: 24px auto; padding: 0 16px; }
    h1 { margin: 0 0 6px; font-size: 1.8rem; }
    h2 { margin: 0 0 16px; font-size: 1.05rem; color: var(--muted); }
    .status { margin: 8px 0 16px; color: var(--muted); }

    .layout {
      display: grid;
      grid-template-columns: 240px 1fr;
      gap: 16px;
      align-items: start;
    }

    /* Left nav (dates from CSV only) */
    #day-nav {
      position: sticky;
      top: 12px;
      align-self: start;
      display: flex;
      flex-direction: column;
      gap: 8px;
      height: calc(100dvh - 24px);
      overflow: hidden; /* no scroll in left column per request */
    }
    .day-btn {
      all: unset;
      display: block;
      padding: 8px 10px;
      background: #1a1f28;
      border: 1px solid #262b36;
      border-radius: 8px;
      color: var(--text);
      cursor: pointer;
    }
    .day-btn:hover { background: #212634; }
    .day-btn.active {
      background: #263143;
      border-color: #344155;
      color: #fff;
      box-shadow: 0 0 0 2px rgba(110,168,254,0.12) inset;
    }

    /* Content area */
    #content-area { min-height: 200px; }
    .day-card { display: none; margin: 0 0 14px; }
    .day-card.visible { display: block; }
    .card-inner {
      background: var(--card);
      border: 1px solid #262b36;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 6px 18px rgba(0,0,0,.18);
    }
    .section { margin: 10px 0; }
    .section h3 { margin: 0 0 6px; font-size: 1.05rem; }
    .section .section-content { color: var(--muted); white-space: pre-wrap; }

    .hint-card .hint {
      color: var(--muted);
      font-size: 0.95rem;
      padding: 12px 14px;
      border-radius: 10px;
      background: #12141a;
      border: 1px dashed #2b3342;
    }

    /* Link pill styling for Video/Slide deck */
    .link-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 4px;
      list-style: none;
      padding: 0;
    }
    a.pill {
      display: inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      background: #1f2530;
      border: 1px solid #2c3443;
      color: var(--accent);
      text-decoration: none;
      font-weight: 600;
      font-size: 0.95rem;
    }
    a.pill:hover { background: #263043; }

    /* Video embed layout */
    .video-list {
      display: grid;
      gap: 12px;
      margin-top: 6px;
    }
    .video-embed {
      position: relative;
      width: 100%;
      max-width: 900px;
      aspect-ratio: 16 / 9;
      background: #000;
      border: 1px solid #2c3443;
      border-radius: 10px;
      overflow: hidden;
    }
    .video-embed iframe,
    .video-embed video {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
    }

    @media (max-width: 860px) {
      .layout { grid-template-columns: 1fr; }
      #day-nav { position: static; height: auto; overflow: visible; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>CompTIA A+ Preparation</h1>
    <h2>Genesee Career Institute</h2>

    <div id="status" class="status">Loading...</div>

    <div class="hint-card">
      <div class="hint">This page loads its content from pacing.csv in the same directory. The left column shows only the dates found in the CSV “Day” column.</div>
    </div>

    <div class="layout" style="margin-top:16px;">
      <nav id="day-nav" aria-label="Lesson dates"></nav>
      <main id="content-area" role="main"></main>
    </div>
  </div>

  <script>
    const CSV_URL = 'pacing.csv';
    let CSV_HEADERS = [];

    document.addEventListener('DOMContentLoaded', () => {
      // Load CSV and render on page load
      loadCsvAndRender();
    });

    const dayCards = Array.from(document.querySelectorAll('.day-card'));
    const validDates = new Set();

    // Extract valid dates from the pacing.csv file
    dayCards.forEach(card => {
      const date = card.getAttribute('data-date');
      if (date) {
        validDates.add(date);
      }
    });

    // Ensure only valid dates are displayed
    dayCards.forEach(card => {
      const date = card.getAttribute('data-date');
      if (!validDates.has(date)) {
        card.style.display = 'none'; // Hide cards for invalid dates
      }
    });

    // Handle navigation buttons
    const dayButtons = Array.from(document.querySelectorAll('.day-btn'));
    dayButtons.forEach(button => {
      const date = button.getAttribute('data-date');
      if (!validDates.has(date)) {
        button.style.display = 'none'; // Hide buttons for invalid dates
      }
    });

    async function loadCsvAndRender() {
      const statusEl = document.getElementById('status');
      try {
        statusEl.textContent = 'Loading pacing.csv...';
        const resp = await fetch(CSV_URL, { cache: 'no-store' });
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const text = await resp.text();

        const rows = csvToObjects(text);
        if (!rows.length) {
          statusEl.textContent = 'No days found in pacing.csv.';
          renderEmpty();
          return;
        }
        renderFromCsv(rows);
        statusEl.textContent = `Loaded ${rows.length} day${rows.length === 1 ? '' : 's'} from pacing.csv.`;
        applyInitialRoute();
      } catch (err) {
        console.error('Failed to load CSV:', err);
        document.getElementById('status').textContent = 'Error loading pacing.csv. Ensure the file exists and is reachable.';
        renderEmpty();
      }
    }

    function renderEmpty() {
      document.getElementById('day-nav').innerHTML = '';
      document.getElementById('content-area').innerHTML = '';
    }

    // Parse CSV to array of objects; first row is headers.
    function csvToObjects(text) {
      const rows = parseCSV(text).filter(r => r.length && r.some(c => (c || '').trim() !== ''));
      if (!rows.length) return [];
      const headers = rows[0].map(h => (h || '').trim());

      // Strip UTF-8 BOM from first header if present (common from Excel)
      if (headers.length) headers[0] = headers[0].replace(/^\uFEFF/, '');

      CSV_HEADERS = headers.slice();
      // Minimal required: Day
      if (!headers.includes('Day')) return [];
      const dataRows = rows.slice(1);
      const objects = dataRows.map(r => {
        const obj = {};
        headers.forEach((h, i) => obj[h] = (r[i] || '').trim());
        return obj;
      }).filter(o => (o.Day || '').trim().length > 0);
      return objects;
    }

    // Robust-ish CSV parser for quotes and commas
    function parseCSV(text) {
      const out = [];
      let row = [], cell = '', inQ = false;
      for (let i = 0; i < text.length; i++) {
        const ch = text[i];
        if (inQ) {
          if (ch === '"') {
            if (text[i + 1] === '"') { cell += '"'; i++; }
            else { inQ = false; }
          } else {
            cell += ch;
          }
        } else {
          if (ch === '"') inQ = true;
          else if (ch === ',') { row.push(cell); cell = ''; }
          else if (ch === '\n') { row.push(cell); out.push(row); row = []; cell = ''; }
          else if (ch === '\r') { /* ignore */ }
          else { cell += ch; }
        }
      }
      if (cell.length > 0 || row.length > 0) { row.push(cell); out.push(row); }
      return out;
    }

    // Build UI strictly from CSV rows (no sequential dates)
    function renderFromCsv(rows) {
      const nav = document.getElementById('day-nav');
      const main = document.getElementById('content-area');
      nav.innerHTML = '';
      main.innerHTML = '';

      rows.forEach((item, idx) => {
        const dayLabel = (item.Day || '').trim(); // use exactly what’s in CSV
        if (!dayLabel) return;

        // Nav button (shows the CSV Day string verbatim)
        const btn = document.createElement('button');
        btn.className = 'day-btn';
        btn.type = 'button';
        btn.textContent = dayLabel;
        btn.dataset.key = dayLabel;
        btn.setAttribute('aria-label', `Open ${dayLabel}`);
        btn.addEventListener('click', () => openDay(dayLabel));
        nav.appendChild(btn);

        // Content card
        const card = document.createElement('article');
        card.className = 'day-card';
        card.setAttribute('data-key', dayLabel);

        let inner = '<div class="card-inner">';
        CSV_HEADERS.forEach(h => {
          if (h === 'Day') return;
          const val = item[h] || '';
          if (!val) return;

          // Render Video/Slide deck as pill links; others as sentences on new lines
          const body = renderField(h, val);

          inner += `
            <div class="section">
              <h3>${escapeHtml(h)}</h3>
              <div class="section-content">${body}</div>
            </div>`;
        });
        inner += '</div>';
        card.innerHTML = inner;
        main.appendChild(card);
      });
    }

    // Render field content: make Video embedded, Slide deck as pill links; others as sentences per line
    function renderField(header, value) {
      const lower = String(header).toLowerCase();
      const isVideo = lower.includes('video');
      const isSlide = lower.includes('slide');

      if (isVideo) {
        const urls = extractUrls(value);
        if (urls.length) {
          const embeds = urls
            .map(u => makeVideoEmbed(u))
            .filter(Boolean)
            .join('');
          if (embeds) return `<div class="video-list">${embeds}</div>`;
        }
        // Fallback to text if no recognizable URL
        return sentencesToLines(value);
      }

      if (isSlide) {
        const urls = extractUrls(value);
        if (urls.length) {
          const many = urls.length > 1;
          const baseLabel = 'View slide deck';
          const links = urls
            .map((u, i) => {
              const safe = sanitizeUrl(u);
              if (!safe) return '';
              const label = many ? `${baseLabel} ${i + 1}` : baseLabel;
              return `<a class="pill" href="${safe}" target="_blank" rel="noopener noreferrer">${label}</a>`;
            })
            .filter(Boolean)
            .join('');
          return `<div class="link-list">${links}</div>`;
        }
        return sentencesToLines(value);
      }

      // Default (escaped with sentence -> newline conversion)
      return sentencesToLines(value);
    }

    // Create an embed for YouTube, Vimeo, or direct video files
    function makeVideoEmbed(url) {
      const safe = sanitizeUrl(url);
      if (!safe) return '';

      // YouTube
      const yt = getYouTubeEmbed(safe);
      if (yt) {
        return `
          <div class="video-embed">
            <iframe
              src="${yt}"
              title="YouTube video"
              frameborder="0"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
              allowfullscreen
              referrerpolicy="strict-origin-when-cross-origin">
            </iframe>
          </div>`;
      }

      // Vimeo
      const vm = getVimeoEmbed(safe);
      if (vm) {
        return `
          <div class="video-embed">
            <iframe
              src="${vm}"
              title="Vimeo video"
              frameborder="0"
              allow="autoplay; fullscreen; picture-in-picture"
              allowfullscreen
              referrerpolicy="strict-origin-when-cross-origin">
            </iframe>
          </div>`;
      }

      // Direct video files (mp4/webm)
      if (/\.(mp4|webm)(\?.*)?$/i.test(safe)) {
        return `
          <div class="video-embed">
            <video controls preload="metadata">
              <source src="${safe}">
              Your browser does not support the video tag.
            </video>
          </div>`;
      }

      // Unknown provider: fall back to a link
      return `<div class="link-list"><a class="pill" href="${safe}" target="_blank" rel="noopener noreferrer">Watch video</a></div>`;
    }

    function getYouTubeEmbed(u) {
      try {
        const url = new URL(u);
        const host = url.hostname.replace(/^www\./, '').toLowerCase();
        let id = '';
        let start = 0;

        if (host === 'youtu.be') {
          id = url.pathname.slice(1);
          start = parseYouTubeStart(url);
        } else if (host.endsWith('youtube.com')) {
          if (url.pathname === '/watch') {
            id = url.searchParams.get('v') || '';
            start = parseYouTubeStart(url);
          } else if (url.pathname.startsWith('/shorts/')) {
            id = url.pathname.split('/')[2] || '';
            start = parseYouTubeStart(url);
          } else if (url.pathname.startsWith('/embed/')) {
            id = url.pathname.split('/')[2] || '';
            start = parseYouTubeStart(url);
          }
        }
        if (!id) return null;

        const params = new URLSearchParams({
          rel: '0',
          modestbranding: '1',
          playsinline: '1'
        });
        if (start > 0) params.set('start', String(start));
        return `https://www.youtube.com/embed/${encodeURIComponent(id)}?${params.toString()}`;
      } catch {
        return null;
      }
    }

    function parseYouTubeStart(url) {
      // Support t=1h2m3s, t=90, start=90
      const t = url.searchParams.get('t') || url.searchParams.get('start');
      if (!t) return 0;
      if (/^\d+$/.test(t)) return parseInt(t, 10);
      const m = t.match(/(?:(\d+)h)?(?:(\d+)m)?(?:(\d+)s)?/i);
      if (!m) return 0;
      const h = parseInt(m[1] || '0', 10);
      const min = parseInt(m[2] || '0', 10);
      const s = parseInt(m[3] || '0', 10);
      return h * 3600 + min * 60 + s;
    }

    function getVimeoEmbed(u) {
      try {
        const url = new URL(u);
        const host = url.hostname.replace(/^www\./, '').toLowerCase();
        if (!host.endsWith('vimeo.com')) return null;
        const parts = url.pathname.split('/').filter(Boolean);
        // Basic vimeo.com/{id}
        const id = parts[0] && /^\d+$/.test(parts[0]) ? parts[0] : '';
        if (!id) return null;
        return `https://player.vimeo.com/video/${id}`;
      } catch {
        return null;
      }
    }

    function openDay(key) {
      const cards = Array.from(document.querySelectorAll('.day-card'));
      const target = cards.find(c => c.getAttribute('data-key') === key);
      if (!target) {
        console.warn('No card found for day:', key);
        return false;
      }
      cards.forEach(c => c.classList.remove('visible'));
      target.classList.add('visible');

      const btns = Array.from(document.querySelectorAll('.day-btn'));
      btns.forEach(b => b.classList.remove('active'));
      const active = btns.find(b => b.dataset.key === key);
      if (active) active.classList.add('active');

      // Update URL hash to the exact CSV Day label
      const enc = encodeURIComponent(key);
      if (location.hash !== `#${enc}`) history.replaceState(null, '', `#${enc}`);

      // Scroll to top like a normal page load
      window.scrollTo({ top: 0, behavior: 'auto' });
      return true;
    }

    function applyInitialRoute() {
      const btns = Array.from(document.querySelectorAll('.day-btn'));
      if (!btns.length) return;
      const hash = decodeURIComponent(location.hash.replace(/^#/, ''));
      if (hash) {
        if (openDay(hash)) return;
      }
      // Fallback to first CSV day
      openDay(btns[0].dataset.key);
    }

    function escapeHtml(s) {
      return String(s)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    // Convert sentences to new lines, preserving URLs by running after escaping.
    function sentencesToLines(s) {
      const escaped = escapeHtml(s);
      // Replace one or more spaces after a period with a newline.
      // Avoid double-breaking if a newline already follows.
      return escaped
        .replace(/\. +/g, '.\n')
        .replace(/\.(?=$)/g, '.'); // keep trailing period as-is
    }
  </script>
</body>
</html>