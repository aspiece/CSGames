<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CompTIA A+ Preparation</title>
  <style>
    :root {
      --bg: #0f1115;
      --card: #171a21;
      --text: #e6e8ee;
      --muted: #b9c0d4;
      --accent: #6ea8fe;
      --border: #2c3443;
    }
    html, body { margin:0; padding:0; background:var(--bg); color:var(--text); font: 14px/1.5 system-ui, Segoe UI, Roboto, Arial, sans-serif; }
    .wrap { max-width: 1100px; margin: 24px auto; padding: 0 16px; }
    h1 { margin: 0 0 6px; font-size: 1.8rem; }
    h2 { margin: 0 0 16px; font-size: 1.05rem; color: var(--muted); }
    .status { margin: 8px 0 16px; color: var(--muted); }

    .layout {
      display: grid;
      grid-template-columns: 260px 1fr;
      gap: 16px;
      align-items: start;
    }

    /* Left nav (dates from CSV only) */
    #day-nav {
      position: sticky;
      top: 12px;
      align-self: start;
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: calc(100dvh - 24px);
      overflow-y: auto;
      padding-right: 4px;
    }
    .day-btn {
      all: unset;
      display: block;
      padding: 8px 10px;
      background: #1a1f28;
      border: 1px solid #262b36;
      border-radius: 8px;
      color: var(--text);
      cursor: pointer;
    }
    .day-btn:hover { background: #212634; }
    .day-btn.active {
      background: #263143;
      border-color: #344155;
      color: #fff;
      box-shadow: 0 0 0 2px rgba(110,168,254,0.12) inset;
    }

    /* Content area */
    #content-area { min-height: 200px; }
    .day-card { display: none; margin: 0 0 14px; }
    .day-card.visible { display: block; }
    .card-inner {
      background: var(--card);
      border: 1px solid #262b36;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 6px 18px rgba(0,0,0,.18);
    }
    .section { margin: 12px 0; }
    .section h3 { margin: 0 0 6px; font-size: 1.05rem; }
    .section .section-content { color: var(--muted); white-space: pre-wrap; }

    /* Slide deck link pills */
    .link-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 6px;
      padding: 0;
      list-style: none;
    }
    a.pill {
      display: inline-block;
      padding: 6px 10px;
      border-radius: 999px;
      background: #1f2530;
      border: 1px solid var(--border);
      color: var(--accent);
      text-decoration: none;
      font-weight: 600;
      font-size: 0.95rem;
    }
    a.pill:hover { background: #263043; }

    /* Video embeds */
    .video-list {
      display: grid;
      gap: 12px;
      margin-top: 6px;
    }
    .video-embed {
      position: relative;
      width: 100%;
      max-width: 900px;
      aspect-ratio: 16 / 9;
      background: #000;
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
    }
    .video-embed iframe,
    .video-embed video {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
    }

    @media (max-width: 860px) {
      .layout { grid-template-columns: 1fr; }
      #day-nav { position: static; max-height: none; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>CompTIA A+ Preparation</h1>
    <h2>Genesee Career Institute</h2>

    <div id="status" class="status">Loading...</div>

    <div class="layout" style="margin-top:16px;">
      <nav id="day-nav" aria-label="Lesson dates"></nav>
      <main id="content-area" role="main"></main>
    </div>
  </div>

  <script>
    const CSV_URL = 'tech+pacing.csv';
    let CSV_HEADERS = [];

    document.addEventListener('DOMContentLoaded', () => {
      loadCsvAndRender();
    });

    async function loadCsvAndRender() {
      const statusEl = document.getElementById('status');
      try {
        statusEl.textContent = 'Loading pacing.csv...';
        const resp = await fetch(CSV_URL, { cache: 'no-store' });
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const text = await resp.text();

        const rows = csvToObjects(text);
        if (!rows.length) {
          statusEl.textContent = 'No days found in pacing.csv.';
          renderEmpty();
          return;
        }
        renderFromCsv(rows);
        statusEl.textContent = `Loaded ${rows.length} day${rows.length === 1 ? '' : 's'} from pacing.csv.`;
        applyInitialRoute();
      } catch (err) {
        console.error('Failed to load CSV:', err);
        statusEl.textContent = 'Error loading pacing.csv. Ensure the file exists and is reachable.';
        renderEmpty();
      }
    }

    function renderEmpty() {
      document.getElementById('day-nav').innerHTML = '';
      document.getElementById('content-area').innerHTML = '';
    }

    // Parse CSV text into array of objects
    function csvToObjects(text) {
      const rows = parseCSV(text).filter(r => r.length && r.some(c => (c || '').trim() !== ''));
      if (!rows.length) return [];

      // Find header row (skip BOM/comment/filepath lines)
      let headerRowIndex = 0;
      while (headerRowIndex < rows.length) {
        const row = rows[headerRowIndex].map(c => (c || '').trim());
        const first = row[0] || '';
        const cleaned = row.map(h => h.replace(/^\uFEFF/, '')); // strip BOM
        if (first.startsWith('//') || first.startsWith('#') || /filepath:/i.test(first)) {
          headerRowIndex++;
          continue;
        }
        rows[headerRowIndex] = cleaned;
        break;
      }

      const headers = rows[headerRowIndex].map(h => (h || '').trim());
      CSV_HEADERS = headers.slice();

      // Require 'Day'
      if (!headers.includes('Day')) {
        console.warn('CSV header row missing "Day". Headers:', headers);
        return [];
      }

      const dataRows = rows.slice(headerRowIndex + 1);
      const objects = dataRows.map(r => {
        const obj = {};
        headers.forEach((h, i) => obj[h] = (r[i] || '').trim());
        return obj;
      }).filter(o => (o.Day || '').trim().length > 0);

      return objects;
    }

    // Robust CSV parser with quotes
    function parseCSV(text) {
      const out = [];
      let row = [], cell = '', inQ = false;
      for (let i = 0; i < text.length; i++) {
        const ch = text[i];
        if (inQ) {
          if (ch === '"') {
            if (text[i + 1] === '"') { cell += '"'; i++; }
            else { inQ = false; }
          } else {
            cell += ch;
          }
        } else {
          if (ch === '"') inQ = true;
          else if (ch === ',') { row.push(cell); cell = ''; }
          else if (ch === '\n') { row.push(cell); out.push(row); row = []; cell = ''; }
          else if (ch === '\r') { /* ignore */ }
          else { cell += ch; }
        }
      }
      if (cell.length > 0 || row.length > 0) { row.push(cell); out.push(row); }
      return out;
    }

    // Build UI strictly from CSV rows
    function renderFromCsv(rows) {
      const nav = document.getElementById('day-nav');
      const main = document.getElementById('content-area');
      nav.innerHTML = '';
      main.innerHTML = '';

      rows.forEach(item => {
        const dayLabel = (item.Day || '').trim(); // exact CSV value
        if (!dayLabel) return;

        // Nav button
        const btn = document.createElement('button');
        btn.className = 'day-btn';
        btn.type = 'button';
        btn.textContent = dayLabel;
        btn.dataset.key = dayLabel;
        btn.setAttribute('aria-label', `Open ${dayLabel}`);
        btn.addEventListener('click', () => openDay(dayLabel));
        nav.appendChild(btn);

        // Content card
        const card = document.createElement('article');
        card.className = 'day-card';
        card.setAttribute('data-key', dayLabel);

        let inner = '<div class="card-inner">';
        CSV_HEADERS.forEach(h => {
          if (h === 'Day') return;
          const val = (item[h] || '').trim();
          if (!val) return;

          const body = renderField(h, val);

          inner += `
            <div class="section">
              <h3>${escapeHtml(h)}</h3>
              <div class="section-content">${body}</div>
            </div>`;
        });
        inner += '</div>';
        card.innerHTML = inner;
        main.appendChild(card);
      });
    }

    // Render fields: Video embeds, Slide deck pills, others sentence-per-line
    function renderField(header, value) {
      const lower = String(header).toLowerCase();
      const isVideo = lower.includes('video');
      const isSlide = lower.includes('slide');

      if (isVideo) {
        const urls = extractUrls(value);
        if (urls.length) {
          const embeds = urls.map(u => makeVideoEmbed(u)).filter(Boolean).join('');
          if (embeds) return `<div class="video-list">${embeds}</div>`;
        }
        return sentencesToLines(value);
      }

      if (isSlide) {
        const urls = extractUrls(value);
        if (urls.length) {
          const many = urls.length > 1;
          const baseLabel = 'View slide deck';
          const links = urls.map((u, i) => {
            const safe = sanitizeUrl(u);
            if (!safe) return '';
            const label = many ? `${baseLabel} ${i + 1}` : baseLabel;
            return `<a class="pill" href="${safe}" target="_blank" rel="noopener noreferrer">${label}</a>`;
          }).filter(Boolean).join('');
          return `<div class="link-list">${links}</div>`;
        }
        return sentencesToLines(value);
      }

      return sentencesToLines(value);
    }

    // Extract URLs (space/comma/semicolon/newline separated)
    function extractUrls(text) {
      if (!text) return [];
      const matches = String(text).match(/https?:\/\/[^\s,;]+/g);
      return matches ? matches.map(s => s.trim()) : [];
    }

    // Allow only http/https links
    function sanitizeUrl(url) {
      try {
        const u = new URL(url);
        if (u.protocol === 'http:' || u.protocol === 'https:') return u.toString();
        return null;
      } catch {
        return null;
      }
    }

    // Video embeds (YouTube, Vimeo, MP4/WebM)
    function makeVideoEmbed(url) {
      const safe = sanitizeUrl(url);
      if (!safe) return '';

      const yt = getYouTubeEmbed(safe);
      if (yt) {
        return `
          <div class="video-embed">
            <iframe
              src="${yt}"
              title="YouTube video"
              frameborder="0"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
              allowfullscreen
              referrerpolicy="strict-origin-when-cross-origin">
            </iframe>
          </div>`;
      }

      const vm = getVimeoEmbed(safe);
      if (vm) {
        return `
          <div class="video-embed">
            <iframe
              src="${vm}"
              title="Vimeo video"
              frameborder="0"
              allow="autoplay; fullscreen; picture-in-picture"
              allowfullscreen
              referrerpolicy="strict-origin-when-cross-origin">
            </iframe>
          </div>`;
      }

      if (/\.(mp4|webm)(\?.*)?$/i.test(safe)) {
        return `
          <div class="video-embed">
            <video controls preload="metadata">
              <source src="${safe}">
              Your browser does not support the video tag.
            </video>
          </div>`;
      }

      return `<div class="link-list"><a class="pill" href="${safe}" target="_blank" rel="noopener noreferrer">Watch video</a></div>`;
    }

    function getYouTubeEmbed(u) {
      try {
        const url = new URL(u);
        const host = url.hostname.replace(/^www\./, '').toLowerCase();
        let id = '';
        let start = parseYouTubeStart(url);

        if (host === 'youtu.be') {
          id = url.pathname.slice(1);
        } else if (host.endsWith('youtube.com')) {
          if (url.pathname === '/watch') {
            id = url.searchParams.get('v') || '';
          } else if (url.pathname.startsWith('/shorts/')) {
            id = url.pathname.split('/')[2] || '';
          } else if (url.pathname.startsWith('/embed/')) {
            id = url.pathname.split('/')[2] || '';
          }
        }
        if (!id) return null;

        const params = new URLSearchParams({ rel: '0', modestbranding: '1', playsinline: '1' });
        if (start > 0) params.set('start', String(start));
        return `https://www.youtube.com/embed/${encodeURIComponent(id)}?${params.toString()}`;
      } catch {
        return null;
      }
    }

    function parseYouTubeStart(url) {
      const t = url.searchParams.get('t') || url.searchParams.get('start');
      if (!t) return 0;
      if (/^\d+$/.test(t)) return parseInt(t, 10);
      const m = t.match(/(?:(\d+)h)?(?:(\d+)m)?(?:(\d+)s)?/i);
      if (!m) return 0;
      const h = parseInt(m[1] || '0', 10);
      const min = parseInt(m[2] || '0', 10);
      const s = parseInt(m[3] || '0', 10);
      return h * 3600 + min * 60 + s;
    }

    function getVimeoEmbed(u) {
      try {
        const url = new URL(u);
        const host = url.hostname.replace(/^www\./, '').toLowerCase();
        if (!host.endsWith('vimeo.com')) return null;
        const parts = url.pathname.split('/').filter(Boolean);
        const id = parts[0] && /^\d+$/.test(parts[0]) ? parts[0] : '';
        if (!id) return null;
        return `https://player.vimeo.com/video/${id}`;
      } catch {
        return null;
      }
    }

    // Sentence -> newline for readability (non-video/slide fields)
    function sentencesToLines(s) {
      const escaped = escapeHtml(s);
      return escaped.replace(/\. +/g, '.\n');
    }

    function openDay(key) {
      const cards = Array.from(document.querySelectorAll('.day-card'));
      const target = cards.find(c => c.getAttribute('data-key') === key);
      if (!target) {
        console.warn('No card found for day:', key);
        return false;
      }
      cards.forEach(c => c.classList.remove('visible'));
      target.classList.add('visible');

      const btns = Array.from(document.querySelectorAll('.day-btn'));
      btns.forEach(b => b.classList.remove('active'));
      const active = btns.find(b => b.dataset.key === key);
      if (active) active.classList.add('active');

      const enc = encodeURIComponent(key);
      if (location.hash !== `#${enc}`) history.replaceState(null, '', `#${enc}`);

      window.scrollTo({ top: 0, behavior: 'auto' });
      return true;
    }

    function applyInitialRoute() {
      const btns = Array.from(document.querySelectorAll('.day-btn'));
      if (!btns.length) return;
      const hash = decodeURIComponent(location.hash.replace(/^#/, ''));
      if (hash && openDay(hash)) return;
      openDay(btns[0].dataset.key);
    }

    function escapeHtml(s) {
      return String(s)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }
  </script>
</body>
</html>