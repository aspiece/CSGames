<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CompTIA Tech+ Preparation</title>
  <style>
    :root{
      --bg:#0f1115;--card:#171a21;--text:#e6e8ee;--muted:#b9c0d4;--accent:#6ea8fe;--border:#2c3443;
      --ok:#2fbf71;--warn:#f7b500;--err:#ff5d5d;
      --btn:#0d6efd;--btn-alt:#495057;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:14px/1.55 system-ui,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    h1{margin:0 0 6px;font-size:1.8rem}
    .layout{display:grid;grid-template-columns:260px 1fr;gap:16px;align-items:start}
    #day-nav{position:sticky;top:12px;display:flex;flex-direction:column;gap:8px;max-height:calc(100dvh - 24px);overflow:auto;padding-right:4px}
    .day-btn{all:unset;display:block;padding:8px 10px;background:#1a1f28;border:1px solid #262b36;border-radius:8px;color:var(--text);cursor:pointer}
    .day-btn:hover{background:#212634}
    .day-btn.active{background:#263143;border-color:#344155;color:#fff;box-shadow:0 0 0 2px rgba(110,168,254,.12) inset}
    #content-area{min-height:200px}
    .day-card{display:none}
    .day-card.visible{display:block}
    .card-inner{background:var(--card);border:1px solid #262b36;border-radius:12px;padding:16px;box-shadow:0 6px 18px rgba(0,0,0,.18)}
    .topline{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin:0 0 8px}
    .time-total{font-weight:700}
    .time-total.ok{color:var(--ok)}
    .time-total.warn{color:var(--warn)}
    .time-total.err{color:var(--err)}
    .section{margin:12px 0}
    .section h3{margin:0 0 6px;font-size:1.05rem}
    .section .meta{color:var(--muted);font-size:.95rem;margin-left:8px}
    .section .section-content{color:var(--muted);white-space:pre-wrap}
    .line-list{margin:6px 0 0;padding-left:18px}
    .line-list li{margin:4px 0}
    /* Slide links and videos (kept minimal for now) */
    .link-list{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px;padding:0;list-style:none}
    a.pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#1f2530;border:1px solid var(--border);color:var(--accent);text-decoration:none;font-weight:600;font-size:.95rem}
    a.pill:hover{background:#263043}
    .video-list{display:grid;gap:12px;margin-top:6px}
    .video-embed{position:relative;width:100%;max-width:900px;aspect-ratio:16/9;background:#000;border:1px solid var(--border);border-radius:10px;overflow:hidden}
    .video-embed iframe,.video-embed video{position:absolute;inset:0;width:100%;height:100%}
    /* Projector Mode */
    .projector-toggle{position:fixed;top:12px;right:12px;z-index:1000;border:0;border-radius:999px;padding:10px 14px;background:var(--btn);color:#fff;font-weight:600;font-size:.95rem;box-shadow:0 6px 18px rgba(0,0,0,.15);cursor:pointer}
    .projector-toggle[aria-pressed="true"]{background:var(--btn-alt)}
    .projector-hint{position:fixed;top:56px;right:16px;z-index:999;color:var(--muted);font-size:.85rem;user-select:none}
    body.projector{font-size:20px;line-height:1.7}
    body.projector h1{font-size:2.1rem}
    body.projector .section h3{font-size:1.25rem}
    @media (max-width:860px){.layout{grid-template-columns:1fr}#day-nav{position:static;max-height:none}}
  </style>
</head>
<body>
  <button id="projectorToggle" class="projector-toggle" type="button" aria-pressed="false" title="Toggle projector mode (Shift+P)">Projector Mode</button>
  <div class="projector-hint" id="projectorHint">Shortcut: Shift+P</div>

  <div class="wrap">
    <header style="margin-bottom:10px">
      <h1>CompTIA Tech+ Preparation</h1>
      <div id="status" style="color:var(--muted)"></div>
    </header>

    <div class="layout">
      <nav id="day-nav" aria-label="Days"></nav>
      <main id="content-area" aria-live="polite"></main>
    </div>
  </div>

  <script>
    // Basic CSV parsing (handles quotes and commas)
    function parseCSV(text){
      const rows=[];let row=[],cell='',q=false;
      for(let i=0;i<text.length;i++){
        const c=text[i],n=text[i+1];
        if(c==='\"'){
          if(q && n==='\"'){cell+='\"';i++;} else {q=!q;}
        } else if(c===',' && !q){row.push(cell);cell='';}
        else if((c==='\n' || c==='\r') && !q){
          if(c==='\r' && n==='\n'){i++;}
          row.push(cell);rows.push(row);row=[];cell='';
        } else {cell+=c;}
      }
      if(cell.length||row.length) {row.push(cell);rows.push(row);}
      // Drop comment or empty header lines
      return rows.filter(r=>r.some(v=>String(v).trim().length));
    }
    function rowsToObjects(rows){
      const header=rows[0].map(h=>h.trim());
      return rows.slice(1).map(r=>{
        const o={};
        header.forEach((h,i)=>o[h]=r[i]??'');
        return o;
      });
    }
    function escapeHtml(s){return String(s??'').replace(/[&<>"']/g,m=>({ '&':'&nbsp;&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]||m)).replace('&nbsp;&amp;','&amp;')}
    function sentencesToLines(s){
      const escaped=escapeHtml(s);
      return escaped.replace(/;(\s+)?/g,'\n').replace(/([.!?])\s+/g,'$1\n');
    }
    function listifyIfNeeded(text){
      if(!text) return '';
      const items=String(text).split(';').map(t=>t.trim()).filter(Boolean);
      if(items.length>=2){return `<ul class="line-list">${items.map(it=>`<li>${escapeHtml(it)}</li>`).join('')}</ul>`;}
      return sentencesToLines(text);
    }
    function extractUrls(text){if(!text) return []; const m=String(text).match(/\bhttps?:\/\/[^\s)]+/g); return m||[];}
    function sanitizeUrl(u){try{const url=new URL(u);return url.protocol==='http:'||url.protocol==='https:'?url.href:'';}catch{return ''}}
    function makeVideoEmbed(u){
      const safe=sanitizeUrl(u); if(!safe) return '';
      // YouTube
      const yt = safe.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([\w-]{11})/);
      if(yt){return `<div class="video-embed"><iframe src="https://www.youtube.com/embed/${yt[1]}" frameborder="0" allowfullscreen></iframe></div>`;}
      return `<div class="video-embed"><iframe src="${safe}" frameborder="0"></iframe></div>`;
    }

    // Render helpers
    function isUrlOnlyCell(value){
      const text = String(value||'').trim();
      if(!text) return false;
      const urls = extractUrls(text);
      if(!urls.length) return false;
      // remove all URLs and trailing separators; if nothing else remains, it's url-only
      const stripped = text.replace(/\bhttps?:\/\/[^\s)]+/g,'').replace(/[\s,;|-]+/g,' ').trim();
      return stripped.length === 0;
    }

    function renderPillLinks(value){
      const urls = (extractUrls(value)||[]).map(sanitizeUrl).filter(Boolean);
      if(!urls.length) return escapeHtml(value||'');
      const many = urls.length>1;
      const items = urls.map((u,i)=>`<a class="pill" href="${u}" target="_blank" rel="noopener noreferrer">${many?`Link ${i+1}`:'Open link'}</a>`);
      return `<div class="link-list">${items.join('')}</div>`;
    }

    function renderField(header,value){
      // If the cell only contains one or more URL(s), render as pill link(s)
      if(isUrlOnlyCell(value)){
        return renderPillLinks(value);
      }
      const lower=String(header).toLowerCase();
      if(lower.includes('video')){
        const urls=extractUrls(value);
        if(urls.length){
          const embeds=urls.map(u=>makeVideoEmbed(u)).filter(Boolean).join('');
          if(embeds) return `<div class="video-list">${embeds}</div>`;
        }
        return listifyIfNeeded(value);
      }
      if(lower.includes('slide')){
        const urls=extractUrls(value);
        if(urls.length){
          // Even for slides, if there is other text, keep as pill links
          return renderPillLinks(value);
        }
        return listifyIfNeeded(value);
      }
      return listifyIfNeeded(value);
    }

    // Render from CSV honoring header order (left-to-right)
    function renderFromCsv(rows, headers){
      const nav=document.getElementById('day-nav');
      const main=document.getElementById('content-area');
      nav.innerHTML=''; main.innerHTML='';

      // Date helpers
      function parseDayStr(s){
        const m=String(s||'').trim().match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
        if(!m) return null;
        const d=new Date(parseInt(m[3],10), parseInt(m[1],10)-1, parseInt(m[2],10));
        if(isNaN(d.getTime())) return null;
        d.setHours(0,0,0,0);
        return d;
      }
      function normalizeDayStr(s){
        const m=String(s||'').trim().match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
        if(!m) return '';
        const mm=m[1].padStart(2,'0'), dd=m[2].padStart(2,'0');
        return `${mm}/${dd}/${m[3]}`;
      }
      function findKeyByNormalized(target, keys){
        const norm = normalizeDayStr(target);
        if(!norm) return '';
        for(const k of keys){ if(normalizeDayStr(k)===norm) return k; }
        return '';
      }

      // Newest-first (descending by Day)
      const sorted = rows.slice().sort((a,b)=>{
        const da=parseDayStr(a['Day']); const db=parseDayStr(b['Day']);
        if(da && db) return db - da;
        if(da && !db) return -1;
        if(!da && db) return 1;
        return String(b['Day']||'').localeCompare(String(a['Day']||''));
      });

      const days=[];

      sorted.forEach(item=>{
        const day=(item['Day']||'').trim(); if(!day) return;
        days.push(day);

        // Nav
        const a=document.createElement('a');
        a.className='day-btn';
        a.href=makeDayHref(day);
        a.textContent=day;
        a.dataset.key=day;
        a.addEventListener('click',(e)=>{ e.preventDefault(); openDay(day,{updateUrl:true}); });
        nav.appendChild(a);

        // Minutes total from any "Minutes:" columns
        let total=0;
        headers.forEach(h=>{
          if(/^Minutes:\s*/i.test(h)){
            const n = Number(String(item[h]||'').trim());
            if(Number.isFinite(n)) total += n;
          }
        });
        const goal=90;
        const statusClass = total===goal ? 'ok' : (total>0 && Math.abs(total-goal)<=5 ? 'warn' : total>goal ? 'err' : 'warn');
        const statusText = total===goal ? 'on target' : total>goal ? 'over' : 'under';

        // Card
        const card=document.createElement('article');
        card.className='day-card'; card.setAttribute('data-key',day);
        let inner = `<div class="card-inner">
          <div class="topline">
            <div class="time-total ${statusClass}">Planned Time: ${total} / ${goal} min (${statusText})</div>
          </div>
        `;

        // Sections in CSV header order (left-to-right), skipping Day and Minutes columns
        headers.forEach(h=>{
          if(h==='Day') return;
          if(/^Minutes:\s*/i.test(h)) return;
          const val = item[h];
          if(!val || String(val).trim()==='') return;
          inner += `
            <div class="section">
              <h3>${escapeHtml(h)}</h3>
              <div class="section-content">${renderField(h,val)}</div>
            </div>`;
        });

        inner += `</div>`;
        card.innerHTML=inner;
        main.appendChild(card);
      });

      // Initial selection: ?day (normalized) > today (normalized) > next upcoming (>= today) > most recent past > first
      const urlDayRaw = getURLDay();
      const urlKey = findKeyByNormalized(urlDayRaw, days);
      const todayStr = formatTodayForCsv();
      const todayKey = findKeyByNormalized(todayStr, days);

      const parsedDays = days
        .map(d => ({ key:d, date:parseDayStr(d) }))
        .filter(x=>x.date)
        .sort((a,b)=>a.date - b.date);

      let initial = '';
      if (urlKey) {
        initial = urlKey;
      } else if (todayKey) {
        initial = todayKey;
      } else {
        const today = new Date(); today.setHours(0,0,0,0);
        const upcoming = parsedDays.find(x => x.date >= today);
        if (upcoming) initial = upcoming.key;
        else if (parsedDays.length) initial = parsedDays[parsedDays.length-1].key;
        else if (days.length) initial = days[0];
      }
      if(initial){ openDay(initial,{updateUrl:!urlDayRaw, replace:true}); }
    }

    // NEW: Helpers for deep-linking
    function makeDayHref(day){
      const u = new URL(window.location.href);
      u.searchParams.set('day', day);
      return u.pathname + u.search; // keep same doc
    }
    function getURLDay(){
      const sp = new URLSearchParams(window.location.search);
      const d = sp.get('day');
      return d ? d.trim() : '';
    }
    function setURLDay(day, {replace}={}){
      const url = makeDayHref(day);
      if(replace){ history.replaceState({day}, '', url); }
      else { history.pushState({day}, '', url); }
    }
    function formatTodayForCsv(){
      const d=new Date();
      const mm=String(d.getMonth()+1).padStart(2,'0');
      const dd=String(d.getDate()).padStart(2,'0');
      const yyyy=d.getFullYear();
      return `${mm}/${dd}/${yyyy}`;
    }

    // CHANGED: openDay now manages URL and active state
    function openDay(key, {updateUrl=false, replace=false}={}){
      document.querySelectorAll('.day-btn')
        .forEach(b=>b.classList.toggle('active', b.dataset.key===key));
      document.querySelectorAll('.day-card')
        .forEach(c=>c.classList.toggle('visible', c.dataset.key===key));
      if(updateUrl){ setURLDay(key, {replace}); }
    }

    // NEW: handle back/forward
    window.addEventListener('popstate', ()=>{
      const d = getURLDay();
      if(d){ openDay(d, {updateUrl:false}); }
    });

    // Remote CSV (Google Sheets) + local fallback
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vT5Cl-zJhR2pasXp3Pim4JEGmEL9tkZEySkdh4UEekBn8dX1mQ8_P6eZ-6wz5TmeHEHTg97ccLT4PaR/pub?gid=2017374015&single=true&output=csv';

    // NEW: refresh function that tries Google Sheets then local fallback
    async function refreshData(){
      const statusEl = document.getElementById('status');
      const sources = [CSV_URL, 'tech%2Bpacing.csv'];
      let lastErr = null;
      for(const url of sources){
        try{
          const res = await fetch(url, {cache:'no-store'});
          if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
          const text = await res.text();
          const raw = parseCSV(text);
          const headers = (raw[0]||[]).map(h=>String(h||'').trim());
          const objects = rowsToObjects(raw);
          renderFromCsv(objects, headers);
          const from = url.includes('docs.google.com') ? 'Google Sheets' : 'local CSV';
          const now = new Date();
          const hh = String(now.getHours()).padStart(2,'0');
          const mm = String(now.getMinutes()).padStart(2,'0');
          const ss = String(now.getSeconds()).padStart(2,'0');
          statusEl.textContent = `Loaded ${objects.length} day(s) from ${from}. Last update ${hh}:${mm}:${ss}.`;
          return;
        }catch(e){
          lastErr = e;
        }
      }
      console.error('CSV load failed:', lastErr);
      statusEl.textContent = 'Failed to load CSV.';
    }

    async function init(){
      try{
        await refreshData();
        // Auto-refresh every 5 minutes
        setInterval(refreshData, 5 * 60 * 1000);
      }catch(err){
        document.getElementById('status').textContent = 'Failed to load CSV.';
        console.error(err);
      }
    }
    init();

    // Projector Mode with persistence and shortcut
    (function projectorMode(){
      const key='projector-mode:v1';
      const btn=document.getElementById('projectorToggle');
      const hint=document.getElementById('projectorHint');
      function apply(on){
        document.body.classList.toggle('projector', !!on);
        btn.setAttribute('aria-pressed', on?'true':'false');
        btn.textContent = on ? 'Exit Projector' : 'Projector Mode';
        localStorage.setItem(key, on?'1':'0');
        if(hint) hint.style.opacity = on ? '0.6' : '1';
      }
      const initial = localStorage.getItem(key)==='1'; apply(initial);
      btn.addEventListener('click',()=>apply(btn.getAttribute('aria-pressed')!=='true'));
      window.addEventListener('keydown',e=>{
        if(e.shiftKey && (e.key==='P'||e.key==='p')){ e.preventDefault(); apply(btn.getAttribute('aria-pressed')!=='true'); }
      });
    })();
  </script>
</body>
</html>