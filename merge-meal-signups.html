<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>The Road Community Church — MERGE Youth Group Sunday Meal Sign-Ups</title>
  <style>
    :root {
      --bg: #ffffff;
      --surface: #f6f9ff;
      --card: #ffffff;
      --ink: #0f172a;
      --muted: #475569;
      --primary: #1f4dbd;
      --primary-ink: #ffffff;
      --accent: #f5b400;
      --open: #10b981;
      --taken: #e11d48;
      --border: #e2e8f0;
      --ring: #93c5fd
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--ink);
      font-family: ui-sans-serif, system-ui, Segoe UI, Roboto, Ubuntu
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 24px
    }

    .header {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 12px
    }

    .brand {
      font-weight: 800;
      letter-spacing: .02em;
      color: var(--primary);
      font-size: 14px;
      text-transform: uppercase
    }

    .h-title {
      font-size: clamp(26px, 4vw, 40px);
      font-weight: 800;
      letter-spacing: -.02em
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 16px;
      margin-top: 10px
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px
    }

    .card.claimed {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px color-mix(in oklab, var(--ring) 35%, transparent)
    }

    .date {
      font-weight: 800
    }

    .row {
      display: flex;
      gap: 8px
    }

    input[type=text] {
      flex: 1;
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      font-size: 14px
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      text-decoration: none;
      background: var(--primary);
      color: var(--primary-ink);
      padding: 12px 16px;
      border-radius: 12px;
      font-weight: 700;
      border: 1px solid transparent;
      cursor: pointer
    }

    .btn[disabled] {
      opacity: .6;
      cursor: not-allowed
    }

    .btn:hover {
      filter: brightness(.97)
    }

    .status {
      display: flex;
      align-items: center;
      gap: 8px
    }

    .pill {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 800
    }

    .pill-open {
      background: var(--open);
      color: #fff
    }

    .pill-taken {
      background: var(--taken);
      color: #fff
    }

    .meta {
      color: var(--muted);
      font-size: 13px
    }

    .claimed-by {
      display: none;
      align-items: center;
      gap: 6px
    }

    .card.claimed .claimed-by {
      display: flex
    }

    .card.claimed .signup-row {
      display: none
    }

    .err {
      color: #b91c1c;
      margin-top: 6px
    }

    footer {
      margin: 28px 0;
      color: var(--muted);
      font-size: 14px;
      text-align: center
    }

    .skel {
      background: var(--surface);
      height: 16px;
      border-radius: 6px;
      animation: pulse 1.2s infinite ease-in-out
    }

    @keyframes pulse {
      0% {
        opacity: .6
      }

      50% {
        opacity: 1
      }

      100% {
        opacity: .6
      }
    }
  </style>

  <script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz1tSs5pjJHffNNin7YnyGVDMfivUaWtISse-MA5oPICm0J7_DwBtHzU9wdYiG0vmjbhQ/exec";
    function jsonp(url) {
      return new Promise((resolve, reject) => {
        const cb = 'cb_' + Math.random().toString(36).slice(2);
        window[cb] = (data) => { resolve(data); cleanup(); };
        function cleanup() { try { delete window[cb]; } catch (_) { } s.remove(); }
        const s = document.createElement('script');
        s.src = url + (url.includes('?') ? '&' : '?') + 'callback=' + cb + '&_ts=' + Date.now();
        s.onerror = () => { cleanup(); reject(new Error('JSONP load error')); };
        document.head.appendChild(s);
      });
    }
    const signupsP = jsonp(SCRIPT_URL + "?action=list");
    const DATES = [{ iso: "2025-09-07", nice: "Sunday, September 7, 2025" }, { iso: "2025-09-14", nice: "Sunday, September 14, 2025" }, { iso: "2025-09-21", nice: "Sunday, September 21, 2025" }, { iso: "2025-09-28", nice: "Sunday, September 28, 2025" }, { iso: "2025-10-05", nice: "Sunday, October 5, 2025" }, { iso: "2025-10-12", nice: "Sunday, October 12, 2025" }, { iso: "2025-10-19", nice: "Sunday, October 19, 2025" }, { iso: "2025-10-26", nice: "Sunday, October 26, 2025" }, { iso: "2025-11-02", nice: "Sunday, November 2, 2025" }, { iso: "2025-11-09", nice: "Sunday, November 9, 2025" }, { iso: "2025-11-16", nice: "Sunday, November 16, 2025" }, { iso: "2025-11-23", nice: "Sunday, November 23, 2025" }, { iso: "2025-11-30", nice: "Sunday, November 30, 2025" }, { iso: "2025-12-07", nice: "Sunday, December 7, 2025" }, { iso: "2025-12-14", nice: "Sunday, December 14, 2025" }, { iso: "2025-12-21", nice: "Sunday, December 21, 2025" }, { iso: "2025-12-28", nice: "Sunday, December 28, 2025" }, { iso: "2026-01-04", nice: "Sunday, January 4, 2026" }, { iso: "2026-01-11", nice: "Sunday, January 11, 2026" }, { iso: "2026-01-18", nice: "Sunday, January 18, 2026" }, { iso: "2026-01-25", nice: "Sunday, January 25, 2026" }, { iso: "2026-02-01", nice: "Sunday, February 1, 2026" }, { iso: "2026-02-08", nice: "Sunday, February 8, 2026" }, { iso: "2026-02-15", nice: "Sunday, February 15, 2026" }, { iso: "2026-02-22", nice: "Sunday, February 22, 2026" }, { iso: "2026-03-01", nice: "Sunday, March 1, 2026" }, { iso: "2026-03-08", nice: "Sunday, March 8, 2026" }, { iso: "2026-03-15", nice: "Sunday, March 15, 2026" }, { iso: "2026-03-22", nice: "Sunday, March 22, 2026" }, { iso: "2026-03-29", nice: "Sunday, March 29, 2026" }, { iso: "2026-04-05", nice: "Sunday, April 5, 2026" }, { iso: "2026-04-12", nice: "Sunday, April 12, 2026" }, { iso: "2026-04-19", nice: "Sunday, April 19, 2026" }, { iso: "2026-04-26", nice: "Sunday, April 26, 2026" }, { iso: "2026-05-03", nice: "Sunday, May 3, 2026" }, { iso: "2026-05-10", nice: "Sunday, May 10, 2026" }, { iso: "2026-05-17", nice: "Sunday, May 17, 2026" }, { iso: "2026-05-24", nice: "Sunday, May 24, 2026" }, { iso: "2026-05-31", nice: "Sunday, May 31, 2026" }];
  </script>

</head>

<body>
  <main class="container">
    <header class="header">
      <div class="brand">The Road Community Church</div>
      <div class="h-title">MERGE Youth Group — Sunday Meal Sign-Ups</div>
      <div id="err" class="err"></div>
      <div id="debug" class="meta"></div>
    </header>

    <section id="grid" class="grid">
      <div class="card">
        <div class="skel" style="width:40%"></div>
        <div class="skel" style="width:70%"></div>
      </div>
      <div class="card">
        <div class="skel" style="width:50%"></div>
        <div class="skel" style="width:60%"></div>
      </div>
      <div class="card">
        <div class="skel" style="width:35%"></div>
        <div class="skel" style="width:65%"></div>
      </div>
    </section>

    <footer>
      The Road Community Church • MERGE Youth Group
    </footer>
  </main>

  <script>
    function cardHTML(d, takenName) {
      const iso = d.iso;
      const nice = d.nice;
      const isTaken = !!takenName;
      return `
    <article class="card ${isTaken ? 'claimed' : ''}" data-iso="${iso}" aria-labelledby="d-${iso}">
      <div id="d-${iso}" class="date">${nice}</div>
      <div class="status" data-openrow="${iso}" style="${isTaken ? 'display:none' : ''}">
        <span class="pill pill-open" data-pill="${iso}">OPEN</span>
        <span class="meta" data-status="${iso}">Available</span>
      </div>
      <div class="claimed-by" data-claimed="${iso}" style="${isTaken ? 'display:flex' : 'display:none'}">
        <span class="pill pill-taken">TAKEN</span>
        <span class="meta">Taken by <strong data-who="${iso}">${takenName || ''}</strong></span>
      </div>
      <div class="signup-row row" style="${isTaken ? 'display:none' : ''}">
        <input type="text" placeholder="Your name" aria-label="Your name for ${nice}" data-input-for="${iso}">
        <button class="btn" data-signup-for="${iso}" data-nice="${nice}">Sign up</button>
      </div>
    </article>
  `;
    }

    function setError(msg) {
      const err = document.getElementById('err');
      if (err) err.textContent = msg || '';
    }

    function renderGrid(signups) {
      const byDate = new Map((signups || []).map(r => [String(r.date_iso).slice(0, 10), r.name]));
      // Find upcoming Sunday (including today if today is Sunday)
      const today = new Date();
      const nextSunday = new Date(today);
      const offset = (7 - today.getDay()) % 7; // 0 if Sunday, else days until Sunday
      nextSunday.setDate(today.getDate() + offset);
      nextSunday.setHours(0, 0, 0, 0);

      // Only show dates starting from upcoming Sunday
      const upcomingDates = DATES.filter(d => {
        const di = new Date(d.iso + 'T00:00:00');
        di.setHours(0, 0, 0, 0);
        return di.getTime() >= nextSunday.getTime();
      });

      const html = upcomingDates.map(d => cardHTML(d, byDate.get(d.iso))).join('');
      const grid = document.getElementById('grid');
      grid.innerHTML = html;
      const dbg = document.getElementById('debug');
      if (dbg) dbg.textContent = 'Loaded ' + (signups ? signups.length : 0) + ' signup(s) • Starting from ' + nextSunday.toLocaleDateString() + ' • ' + new Date().toLocaleTimeString();
    }

    // Render as soon as signups arrive
    signupsP.then(renderGrid).catch(err => {
      console.error(err);
      setError('Could not load signups. If you opened this file directly, try hosting it or check the Apps Script deployment and permissions.');
      renderGrid([]);
    });

    async function submitSignup(form) {
      try {
        const res = await fetch(SCRIPT_URL, { method: 'POST', body: form, mode: 'cors' });
        if (res.ok || res.type === 'opaque') return true;
      } catch (_) {
        // Fall through to JSONP fallback.
      }

      const qs = new URLSearchParams(form);
      const url = SCRIPT_URL + '?' + qs.toString();
      const result = await jsonp(url);
      if (result && result.ok === false) {
        throw new Error(result.message || 'Signup failed');
      }
      return true;
    }

    async function signup(iso, nice) {
      const input = document.querySelector(`[data-input-for="${iso}"]`);
      const btn = document.querySelector(`[data-signup-for="${iso}"]`);
      const name = (input?.value || '').trim();
      if (!name) { alert("Please enter your name."); input?.focus(); return; }
      btn?.classList.add('loading');
      setError('');
      try {
        const form = new URLSearchParams();
        form.set('action', 'signup');
        form.set('date_iso', iso);
        form.set('date_nice', nice);
        form.set('name', name);
        const ok = await submitSignup(form);
        if (ok) {
          // Hot-update card
          const card = document.querySelector(`[data-iso="${iso}"]`);
          if (card) {
            card.classList.add('claimed');
            const openRow = card.querySelector(`[data-openrow="${iso}"]`);
            if (openRow) openRow.style.display = 'none';
            const claimed = card.querySelector(`[data-claimed="${iso}"]`);
            const who = card.querySelector(`[data-who="${iso}"]`);
            if (claimed) claimed.style.display = 'flex';
            if (who) who.textContent = name;
            const btn2 = card.querySelector(`[data-signup-for="${iso}"]`);
            const in2 = card.querySelector(`[data-input-for="${iso}"]`);
            if (btn2) btn2.setAttribute('disabled', '');
            if (in2) in2.setAttribute('disabled', '');
          }
          // Re-fetch in case of races
          jsonp(SCRIPT_URL + "?action=list").then(renderGrid);
        }
      } catch (e) {
        console.error(e);
        setError('Signup failed. Please verify the Apps Script web app is deployed to "Anyone" and supports this action.');
        alert("Could not submit your signup. Please try again.");
      } finally {
        btn?.classList.remove('loading');
      }
    }

    document.addEventListener('click', (e) => {
      const btn = e.target.closest('[data-signup-for]');
      if (!btn) return;
      const iso = btn.getAttribute('data-signup-for');
      const nice = btn.getAttribute('data-nice');
      signup(iso, nice);
    });
  </script>

</body>

</html>